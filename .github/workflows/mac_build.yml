name: build-macos-app

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: macos-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        env:
          CT_METAL: 1
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -r requirements.txt
          # Reinstall ctransformers from source for Apple Silicon (Metal)
          python -m pip uninstall -y ctransformers
          python -m pip install --no-binary ctransformers ctransformers

      - name: Build .app with PyInstaller
        run: |
          pyinstaller forensic_summarizer.spec

      - name: Download GGUF model into .app bundle
        run: |
          APP_RESOURCES_DIR="dist/forensic_summarizer.app/Contents/Resources/backend/llm_models"
          mkdir -p "$APP_RESOURCES_DIR"
          curl -L -o "$APP_RESOURCES_DIR/Mistral-7B-Instruct-v0.3.Q4_K_M.gguf" \
            "https://huggingface.co/TheBloke/Mistral-7B-Instruct-v0.3-GGUF/resolve/main/mistral-7b-instruct-v0.3.Q4_K_M.gguf"

      # --- SIGNING KEYCHAIN SETUP ---
      - name: Import Developer ID certificate (.p12) into temporary keychain
        env:
          APPLE_CERT_P12_BASE64: ${{ secrets.APPLE_CERT_P12_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          set -euo pipefail

          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"

          echo "$APPLE_CERT_P12_BASE64" | base64 --decode > "$RUNNER_TEMP/cert.p12"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Allow codesign/productbuild to access the key
          security import "$RUNNER_TEMP/cert.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$APPLE_CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security \
            -T /usr/bin/productbuild

          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Detect signing identity (debug)
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="${KEYCHAIN_PATH}"

          echo "=== Available code signing identities in temporary keychain ==="
          security find-identity -p codesigning -v "$KEYCHAIN_PATH" || true

          echo "=== Available certificates in temporary keychain (names) ==="
          security find-certificate -a "$KEYCHAIN_PATH" | grep "labl" || true

          SIGN_IDENTITY="$(security find-identity -p codesigning -v "$KEYCHAIN_PATH" \
            | awk -F\" '/Developer ID Application/ {print $2; exit}')"

          if [ -z "${SIGN_IDENTITY}" ]; then
            echo "ERROR: No 'Developer ID Application' identity found in keychain."
            echo "Most likely the .p12 is not a Developer ID Application cert, or it does not include the private key."
            exit 1
          fi

          echo "SIGN_IDENTITY=$SIGN_IDENTITY" >> "$GITHUB_ENV"
          echo "Using SIGN_IDENTITY=$SIGN_IDENTITY"

      - name: Create entitlements (minimal)
        run: |
          set -euo pipefail
          ENTITLEMENTS_PATH="$RUNNER_TEMP/entitlements.plist"
          cat > "$ENTITLEMENTS_PATH" <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>com.apple.security.cs.disable-library-validation</key>
            <true/>
          </dict>
          </plist>
          EOF
          echo "ENTITLEMENTS_PATH=$ENTITLEMENTS_PATH" >> "$GITHUB_ENV"

      - name: Codesign .app (hardened runtime)
        run: |
          set -euo pipefail

          APP_PATH="dist/forensic_summarizer.app"
          SIGN_IDENTITY="${SIGN_IDENTITY}"
          ENTITLEMENTS_PATH="${ENTITLEMENTS_PATH}"

          # Sign embedded frameworks first (if any)
          if [ -d "$APP_PATH/Contents/Frameworks" ]; then
            find "$APP_PATH/Contents/Frameworks" -type d -name "*.framework" -print0 | while IFS= read -r -d '' fw; do
              codesign --force --options runtime --timestamp --sign "$SIGN_IDENTITY" "$fw"
            done
          fi

          # Sign common binary types inside the bundle
          find "$APP_PATH" -type f \( -name "*.dylib" -o -name "*.so" -o -name "*.bundle" \) -print0 | while IFS= read -r -d '' f; do
            codesign --force --options runtime --timestamp --sign "$SIGN_IDENTITY" "$f"
          done

          # Sign main executables (PyInstaller puts them here)
          if [ -d "$APP_PATH/Contents/MacOS" ]; then
            find "$APP_PATH/Contents/MacOS" -type f -print0 | while IFS= read -r -d '' f; do
              codesign --force --options runtime --timestamp --sign "$SIGN_IDENTITY" "$f"
            done
          fi

          # Finally sign the app bundle with entitlements
          codesign --force --options runtime --timestamp \
            --entitlements "$ENTITLEMENTS_PATH" \
            --sign "$SIGN_IDENTITY" \
            "$APP_PATH"

          # Verify signature
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

      # --- NOTARIZATION ---
      - name: Create zip for notarization (ditto keepParent)
        run: |
          set -euo pipefail
          APP_PATH="dist/forensic_summarizer.app"
          ditto -c -k --keepParent "$APP_PATH" "dist/forensic_summarizer-notary.zip"

      - name: Notarize with Apple ID (notarytool)
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          set -euo pipefail
          xcrun notarytool submit "dist/forensic_summarizer-notary.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

      - name: Staple notarization ticket to .app
        run: |
          set -euo pipefail
          APP_PATH="dist/forensic_summarizer.app"
          xcrun stapler staple "$APP_PATH"
          xcrun stapler validate "$APP_PATH"

      - name: Create final distributable zip (ditto keepParent)
        run: |
          set -euo pipefail
          APP_PATH="dist/forensic_summarizer.app"
          rm -f "dist/forensic_summarizer.app.zip"
          ditto -c -k --keepParent "$APP_PATH" "dist/forensic_summarizer.app.zip"

      # --- RELEASE ---
      - name: Create GitHub Release (draft)
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: mac-build-${{ github.run_number }}
          release_name: "macOS build ${{ github.run_number }}"
          draft: true
          prerelease: false

      - name: Upload .app.zip to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist/forensic_summarizer.app.zip
          asset_name: forensic_summarizer.app.zip
          asset_content_type: application/zip
